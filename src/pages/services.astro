---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { marked } from "marked";

// Helper function to create URL-friendly slugs
function slugify(text) {
  if (!text) return "";
  return text.toString().toLowerCase().trim()
    .replace(/\s+/g, "-").replace(/[^\w-]+/g, "")
    .replace(/--+/g, "-").replace(/^-+/, "").replace(/-+$/, "");
}

const services = await getCollection("services");
const sortedServices = services.sort((a, b) => a.data.order - b.data.order);

sortedServices.forEach((service) => {
  service.data.id = slugify(service.data.title);
  service.compiledContent = marked.parse(service.body);
});
---

<BaseLayout title="Services">
  <section class="services-main relative">
    {/* --- STATIC TABLE OF CONTENTS HEADER --- */}
    {/* Removed sticky and top-0. It flows normally before the services container. */}
    {/* z-index might not be needed unless overlapping other static content. */}
    <div id="services-toc-header" class="bg-neutral-800 text-white shadow-md">
      <div class="container mx-auto px-8 py-4">
        <h2 class="text-xl font-semibold mb-2 text-gold">Our Services</h2>
        <ul class="flex flex-wrap gap-x-4 gap-y-2 text-sm">
          {sortedServices.map((service) => (
            <li>
              <a href={`#${service.data.id}`}
                 data-target-id={service.data.id}
                 class="toc-link hover:text-gold transition-colors duration-200 pb-1">
                {service.data.title}
              </a>
            </li>
          ))}
        </ul>
      </div>
    </div>
    {/* --- END STATIC TABLE OF CONTENTS HEADER --- */}

    {/* Services sections */}
    <div class="services-container relative">
      {sortedServices.map((service, index) => (
        <div class="service-sticky-wrapper border-t border-gray-800"
             data-index={index}
             id={service.data.id}>
          <div class="service-section-content py-24 w-full reveal-animation">
            <div class="service-content h-full w-full flex items-center">
              <div class="container mx-auto px-8">
                <div class="flex flex-col md:flex-row">
                  <div class="md:w-1/4 mb-8 md:mb-0">
                  </div>
                  <div class="md:w-3/4">
                    <h2 class="text-3xl md:text-4xl font-bold mb-8 text-gold font-serif">
                      {service.data.title}
                    </h2>
                    <div class="prose prose-invert prose-lg max-w-3xl" set:html={service.compiledContent} />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      ))}
    </div>
  </section>
</BaseLayout>

<style>
  .services-main {
    background-color: #1a1a1a;
    color: white;
  }

  #services-toc-header {
    background-color: #1a1a1a;
    border-bottom: 1px solid #333;
  }

  .toc-link.active {
    color: var(--color-gold);
    border-bottom: 1px solid var(--color-gold);
  }

  .services-container {
    position: relative;
  }

  .service-sticky-wrapper {
    background-color: #1a1a1a;
    width: 100%;
    display: flex;
    align-items: center;
  }

  .service-sticky-wrapper.sticky {
    position: sticky;
    top: 0;
    z-index: var(--index, 1);
  }

  .service-section-content {
    width: 100%;
  }

  .reveal-animation {
    opacity: 1;
  }

  .prose h3 {
    font-size: 1.5rem;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
    color: var(--color-gold);
  }

  :root { --color-gold: #d4af37; }
</style>

<script src="../scripts/servicesPage.js"></script>
